FROM node:22

# Set environment variables
ENV APP_HOST=0.0.0.0
ENV BE_UNIX_SOCKET=1
ENV FE_UNIX_SOCKET=1
ENV BE_UNIX_SOCKET_PATH=/tmp/taskosaur-backend.sock
ENV FE_UNIX_SOCKET_PATH=/tmp/taskosaur-frontend.sock

WORKDIR /app/taskosaur

# Copy root package files
COPY package*.json ./
COPY *.js ./

# Copy essential directories (node_modules excluded via .dockerignore)
COPY taskosaur/ ./taskosaur/
COPY backend/ ./backend/
COPY frontend/ ./frontend/

RUN npm install -g npm@latest

# Install taskosaur dependencies
RUN npm install

# Install backend dependencies and rebuild native modules
WORKDIR /app/taskosaur/backend
RUN npm clean-install && npm rebuild

# Install frontend dependencies
WORKDIR /app/taskosaur/frontend  
RUN npm clean-install && npm rebuild

WORKDIR /app/taskosaur

CMD ["bash", "-c", "npm install && npm run be:install && npm run fe:install && npm run be:prisma:migrate:deploy && npm run start:dev"]